<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalon Online</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='i18n.js') }}"></script>
    <!-- 添加 marked.js，确保在其他脚本之前加载 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script>
        // 全局变量
        let currentLang = localStorage.getItem('lang') || 'zh';
        let socket = null;
        
        function setLanguage(lang) {
            console.log('Language change requested:', lang);  // 调试日志
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lang: lang })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Language changed to:', lang);
                    // 重新连接 socket，带上新的语言参数
                    if (socket) {
                        console.log('Disconnecting existing socket');
                        socket.disconnect();
                        socket = null;
                    }
                    console.log('Creating new socket connection with language:', lang);
                    socket = io({
                        query: { lang: lang }
                    });
                    setupSocketListeners();  // 重新设置 socket 监听器
                    
                    // 更新按钮状态
                    document.getElementById('zh-btn').classList.toggle('active', lang === 'zh');
                    document.getElementById('en-btn').classList.toggle('active', lang === 'en');
                    updateUIText();
                    if (document.getElementById('rules-content').style.display !== 'none') {
                        loadRules();
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function getText(key, params = {}) {
            let text = translations[currentLang][key];
            if (!text) return key;  // 如果找不到翻译，返回key
            // 替换参数
            for (const [key, value] of Object.entries(params)) {
                text = text.replace(`{${key}}`, value);
            }
            return text;
        }
        
        function updateUIText() {
            // 更新所有需要翻译的元素
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const params = JSON.parse(element.getAttribute('data-i18n-params') || '{}');
                element.textContent = getText(key, params);
            });
        }
        
        // 初始化 socket 连接
        function initializeSocket() {
            if (socket) {
                console.log('Socket already exists, skipping initialization');
                return;
            }
            console.log('Initializing socket with language:', currentLang);
            socket = io({
                query: { lang: currentLang }
            });
            setupSocketListeners();
        }
        
        // 设置 socket 事件监听器
        function setupSocketListeners() {
            if (!socket) {
                console.error('Cannot setup listeners: socket is null');
                return;
            }
            socket.on('connect', () => {
                console.log('Socket connected with language:', currentLang);
            });
        
            socket.on('disconnect', () => {
                console.log('Socket disconnected');
            });
        
            socket.on('game_update', function(data) {
                try {
                    console.log('Received game update:', data);
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${data.type}`;
                    messageDiv.textContent = data.message;
                    
                    // 如果是输入提示，显示输入框
                    if (data.type === 'input_prompt') {
                        const inputForm = document.createElement('form');
                        const inputField = document.createElement('input');
                        const submitButton = document.createElement('button');
                        
                        inputField.type = 'text';
                        submitButton.textContent = '提交';
                        
                        inputForm.onsubmit = function(e) {
                            e.preventDefault();
                            const input = inputField.value;
                            console.log('Sending player input:', input);  // 调试信息
                            socket.emit('player_input', { input: input });
                            inputField.value = '';
                            inputForm.style.display = 'none';
                        };
                        
                        inputForm.appendChild(inputField);
                        inputForm.appendChild(submitButton);
                        messageDiv.appendChild(inputForm);
                    }
                    
                    const messagesDiv = document.getElementById('messages');
                    if (messagesDiv) {
                        messagesDiv.appendChild(messageDiv);
                        messageDiv.scrollIntoView();
                    } else {
                        console.error('Messages container not found');
                    }
                } catch (error) {
                    console.error('Error handling game update:', error);
                }
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            updateUIText();
            initializeSocket();  // 初始化 socket 连接
        });

        async function loadRules() {
            try {
                const response = await fetch(`/rules/${currentLang}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                document.querySelector('.rules-text').innerHTML = marked.parse(data.content);
            } catch (error) {
                console.error('Error loading rules:', error);
                document.querySelector('.rules-text').innerHTML = `
                    <div class="error-message">
                        <p>无法加载规则文件。</p>
                        <p>Error: ${error.message}</p>
                    </div>`;
            }
        }

        function toggleRules() {
            const rulesContent = document.getElementById('rules-content');
            if (rulesContent.style.display === 'none') {
                rulesContent.style.display = 'block';
                loadRules();  // 加载规则内容
            } else {
                rulesContent.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <button onclick="setLanguage('zh')" class="lang-btn" id="zh-btn">中文</button>
            <button onclick="setLanguage('en')" class="lang-btn" id="en-btn">English</button>
        </div>
        <h1 data-i18n="game_title"></h1>
        <div class="user-stats">
            <h3 data-i18n="welcome" data-i18n-params='{"username": "{{ user.username }}"}'></h3>
            <a href="{{ url_for('logout') }}" class="logout-btn" data-i18n="logout"></a>
        </div>
        <div id="rules-section">
            <button onclick="toggleRules()" class="rules-button" data-i18n="rules_button"></button>
            <div id="rules-content" class="rules-modal" style="display: none;">
                <div class="rules-modal-content">
                    <span class="close-button" onclick="toggleRules()">&times;</span>
                    <h2 data-i18n="rules_title"></h2>
                    <div class="rules-text"></div>
                </div>
            </div>
        </div>
        <div id="game-controls">
            {% if user and user.is_admin %}
            <div class="admin-controls">
                <div class="game-options">
                    <div class="checkbox-option">
                        <label>
                            <input type="checkbox" id="random-team-checkbox" checked onchange="toggleTeamSelection()">
                            <span data-i18n="random_team"></span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <label>
                            <input type="checkbox" id="include-human-checkbox" onchange="updateGameOptions()">
                            <span data-i18n="include_human"></span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label for="simulation-count" data-i18n="simulation_count"></label>
                        <input type="number" id="simulation-count" value="1" min="1" max="100" title="请输入1-100之间的数字">
                    </div>
                    <div class="player-models">
                        <h4 data-i18n="player_model_settings">Player Model Settings</h4>
                        {% for i in range(1, 6) %}
                        <div class="player-model-select">
                            <label for="p{{i}}-model">P{{i}}:</label>
                            <select id="p{{i}}-model" class="model-select">
                                <option value="gemini" selected="selected">Gemini 2.0</option>
                                <option value="chatgpt">ChatGPT</option>
                                <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                                <option value="doubao-lite">豆包 Lite</option>
                                <option value="glm-zero">GLM Zero</option>
                                <option value="ollama-32b">Ollama 32B</option>
                                <option value="ollama-7b">Ollama 7B</option>
                                <option value="siliconflow">Silicon Flow</option>
                            </select>
                            <select id="p{{i}}-team" class="team-select" disabled>
                                <option value="random" data-i18n="team_random"></option>
                                <option value="blue" data-i18n="team_blue"></option>
                                <option value="red" data-i18n="team_red"></option>
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            <button onclick="startGame()" data-i18n="start_new_game"></button>
            {% if user and user.is_admin %}
            <button onclick="startTestGame()" class="test-button" data-i18n="start_test_game"></button>
            <div class="export-controls">
                <button onclick="exportData('excel')" class="export-button" data-i18n="export_excel"></button>
                <button onclick="exportData('training')" class="export-button" data-i18n="export_training"></button>
            </div>
            {% endif %}
        </div>
        <div id="messages" class="log-container"></div>
        <div class="test-mode-options" id="testModeOptions" style="display: none;">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="p5IsMorgan" name="p5_is_morgan">
                <label class="form-check-label" for="p5IsMorgan">
                    Set P5 as Morgan
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="includeHuman" name="include_human">
                <label class="form-check-label" for="includeHuman">
                    Include Human Player
                </label>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
    function toggleTeamSelection() {
        const randomTeam = document.getElementById('random-team-checkbox').checked;
        const teamSelects = document.querySelectorAll('.team-select');
        
        teamSelects.forEach(select => {
            select.disabled = randomTeam;
            if (randomTeam) {
                select.value = 'random';
            }
        });
    }

    function startGame() {
        try {
            console.log('Starting game...');
            const includeHuman = document.getElementById('include-human-checkbox').checked;
            const randomTeam = document.getElementById('random-team-checkbox').checked;
            let simulationCount = parseInt(document.getElementById('simulation-count').value);
            
            // 验证模拟次数
            if (isNaN(simulationCount) || simulationCount < 1 || simulationCount > 100) {
                console.warn('Invalid simulation count, using default value 1');
                simulationCount = 1;
                document.getElementById('simulation-count').value = '1';
            }
            
            const playerModels = {};
            const playerTeams = {};
            
            for (let i = 1; i <= 5; i++) {
                playerModels[`P${i}`] = document.getElementById(`p${i}-model`).value;
                playerTeams[`P${i}`] = document.getElementById(`p${i}-team`).value;
            }
            
            console.log('Sending data:', {  // 添加调试日志
                include_human: includeHuman,
                player_models: playerModels,
                random_team: randomTeam,
                player_teams: playerTeams,
                simulation_count: simulationCount
            });
            
            socket.emit('start_game', {
                include_human: includeHuman,
                player_models: playerModels,
                random_team: randomTeam,
                player_teams: playerTeams,
                simulation_count: simulationCount
            });
        } catch (error) {
            console.error('Error starting game:', error);
        }
    }

    function startTestGame() {
        console.log('Starting test game...');
        try {
            const p5IsMorgan = document.getElementById('p5-morgan-checkbox').checked;
            const includeHuman = document.getElementById('include-human-checkbox').checked;
            console.log('P5 is morgan:', p5IsMorgan);  // 添加调试日志
            console.log('Include human:', includeHuman);  // 添加调试日志
            socket.emit('start_test_game', { 
                p5_is_morgan: p5IsMorgan,
                include_human: includeHuman
            });
        } catch (error) {
            console.error('Error starting test game:', error);
        }
    }

    function updateTestOptions() {
        const morganCheckbox = document.getElementById('p5-morgan-checkbox');
        const humanCheckbox = document.getElementById('include-human-checkbox');
        console.log('Test options updated:', { 
            p5_is_morgan: morganCheckbox.checked,
            include_human: humanCheckbox.checked
        });
    }

    function exportData(format) {
        fetch(`/export/${format}`)
            .then(response => {
                if (format === 'excel') {
                    return response.blob();
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (format === 'excel') {
                    // 下载 Excel 文件
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'avalon_game_data.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    // 下载 JSON 训练数据
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'avalon_training_data.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
            })
            .catch(error => console.error('Error exporting data:', error));
    }

    function updateGameOptions() {
        const humanCheckbox = document.getElementById('include-human-checkbox');
        console.log('Game options updated:', {
            include_human: humanCheckbox.checked
        });
    }
    </script>
</body>
</html>

